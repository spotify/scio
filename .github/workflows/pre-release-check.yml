name: pre-release-check

env:
  SBT_OPTS: -DbeamRunners=DataflowRunner -Dbigquery.project=data-integration-test
  DEFAULT_DATAFLOW_ARGS: --runner=DataflowRunner --project=data-integration-test --region=europe-west1 --tempLocation=gs://dataflow-tmp-europe-west1/gha

on:
  workflow_dispatch # Manually triggered
jobs:
  test-dataflow:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v2.4.0
      - id: gcloud-auth
        uses: google-github-actions/auth@v0
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      - name: cache SBT
        uses: coursier/cache-action@v6
      - name: Java setup
        uses: actions/setup-java@v2
        with:
          distribution: temurin
          java-version: 11
      - name: (Dataflow) IO Writes
        run: sbt ${{ env.SBT_OPTS }} "scio-examples/runMain ${{ matrix.io_write }} ${{ env.DEFAULT_DATAFLOW_ARGS }} "
      - name: (Dataflow) IO Reads
        run: sbt ${{ env.SBT_OPTS }} "scio-examples/runMain ${{ matrix.io_read }} ${{ env.DEFAULT_DATAFLOW_ARGS }}"
    strategy:
      matrix:
        io_write:
          - com.spotify.scio.examples.extra.AvroExample --method=specificOut --output=gs://data-integration-test-eu/AvroExample/Write/${{ github.run_id }}
        io_read:
          - com.spotify.scio.examples.extra.AvroExample --method=specificIn --input=gs://data-integration-test-eu/AvroExample/Write/${{ github.run_id }}/*.avro --output=gs://data-integration-test-eu/AvroExample/Read/${{ github.run_id }}
