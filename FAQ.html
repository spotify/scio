<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Scio - Documentation">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Scio - Documentation">
<link rel="shortcut icon" href="images/favicon.ico">
<title>FAQ Â· Scio</title>
<link rel="stylesheet" href="assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="assets/stylesheets/application-palette.22915126.css">
<link rel="stylesheet" href="lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="lib/prettify/prettify.css">
<script src="assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="assets/fonts/font-awesome.css">
<link rel="stylesheet" href="assets/fonts/material-icons.css">
<link rel="stylesheet" href="assets/stylesheets/paradox-material-theme.css">
</head>
<body
data-md-color-primary="white"
data-md-color-accent="indigo"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="index.html" title="Scio" class="md-header-nav__button md-logo">
<img src="images/logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Scio
</span>
<span class="md-header-nav__topic">
FAQ
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/spotify/scio"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
spotify/scio
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="index.html" title="Scio" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="images/logo.png" width="24" height="24">
</a>
<a href="index.html" title="Scio">
Scio
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/spotify/scio"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
spotify/scio
</div>
</a>

</div>
<ul>
  <li><a href="Getting-Started.html" class="page">Getting Started</a></li>
  <li><a href="examples.html" class="page">Examples</a></li>
  <li><a href="io/index.html" class="page">IO</a>
  <ul>
    <li><a href="io/Type-Safe-BigQuery.html" class="page">BigQuery</a></li>
    <li><a href="io/Bigtable.html" class="page">Bigtable</a></li>
    <li><a href="io/Avro.html" class="page">Avro</a></li>
    <li><a href="io/Protobuf.html" class="page">Protobuf</a></li>
    <li><a href="io/Parquet.html" class="page">Parquet</a></li>
  </ul></li>
  <li><a href="Scio-Unit-Tests.html" class="page">Testing</a></li>
  <li><a href="Scio-REPL.html" class="page">REPL</a></li>
  <li><a href="internals/index.html" class="page">Internals</a>
  <ul>
    <li><a href="internals/Coders.html" class="page">Coder Typeclass</a></li>
    <li><a href="internals/Kryo.html" class="page">Kryo</a></li>
    <li><a href="internals/OverrideTypeProvider.html" class="page">OverrideTypeProvider</a></li>
    <li><a href="internals/ScioIO.html" class="page">ScioIO</a></li>
  </ul></li>
  <li><a href="extras/index.html" class="page">Extras</a>
  <ul>
    <li><a href="extras/Algebird.html" class="page">Algebird</a></li>
  </ul></li>
  <li><a href="migrations/index.html" class="page">Migration Guides</a>
  <ul>
    <li><a href="migrations/v0.7.0-Migration-Guide.html" class="page">Scio v0.7.0</a></li>
    <li><a href="migrations/v0.8.0-Migration-Guide.html" class="page">Scio v0.8.0</a></li>
  </ul></li>
  <li><a href="dev/index.html" class="page">Development</a>
  <ul>
    <li><a href="dev/build.html" class="page">Build</a></li>
    <li><a href="dev/Style-Guide.html" class="page">Style Guide</a></li>
    <li><a href="dev/How-to-Release.html" class="page">How to Release</a></li>
    <li><a href="dev/Design-Philosophy.html" class="page">Design Philosophy</a></li>
  </ul></li>
  <li><a href="scaladoc.html" class="page">Scaladoc</a></li>
  <li><a href="Scio,-Beam-and-Dataflow.html" class="page">Scio, Beam and Dataflow</a></li>
  <li><a href="Scio,-Scalding-and-Spark.html" class="page">Scio, Spark and Scalding</a></li>
  <li><a href="Runners.html" class="page">Runners</a></li>
  <li><a href="Scio-data-guideline.html" class="page">Data Guidelines</a></li>
  <li><a href="Apache-Beam.html" class="page">Versions</a></li>
  <li><a href="Changelog.html" class="page">Changelog</a></li>
  <li><a href="FAQ.html" class="active page">FAQ</a></li>
  <li><a href="Powered-By.html" class="page">Powered By</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="FAQ.html#faq" class="header">FAQ</a>
  <ul>
    <li><a href="FAQ.html#general-questions" class="header">General questions</a></li>
    <li><a href="FAQ.html#programming-questions" class="header">Programming questions</a></li>
    <li><a href="FAQ.html#bigquery-questions" class="header">BigQuery questions</a></li>
    <li><a href="FAQ.html#streaming-questions" class="header">Streaming questions</a></li>
    <li><a href="FAQ.html#other-io-components" class="header">Other IO components</a></li>
    <li><a href="FAQ.html#development-environment-issues" class="header">Development environment issues</a></li>
    <li><a href="FAQ.html#common-issues" class="header">Common issues</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.8.2*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="FAQ.html#faq" class="header">FAQ</a>
  <ul>
    <li><a href="FAQ.html#general-questions" class="header">General questions</a></li>
    <li><a href="FAQ.html#programming-questions" class="header">Programming questions</a></li>
    <li><a href="FAQ.html#bigquery-questions" class="header">BigQuery questions</a></li>
    <li><a href="FAQ.html#streaming-questions" class="header">Streaming questions</a></li>
    <li><a href="FAQ.html#other-io-components" class="header">Other IO components</a></li>
    <li><a href="FAQ.html#development-environment-issues" class="header">Development environment issues</a></li>
    <li><a href="FAQ.html#common-issues" class="header">Common issues</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#faq" name="faq" class="anchor"><span class="anchor-link"></span></a>FAQ</h1>
<div class="toc ">
<ul>
  <li><a href="FAQ.html#general-questions" class="header">General questions</a>
  <ul>
    <li><a href="FAQ.html#whats-the-status-of-scio-" class="header">What&rsquo;s the status of Scio?</a></li>
    <li><a href="FAQ.html#whos-using-scio-" class="header">Who&rsquo;s using Scio?</a></li>
    <li><a href="FAQ.html#whats-the-relationship-between-scio-and-apache-beam-" class="header">What&rsquo;s the relationship between Scio and Apache Beam?</a></li>
    <li><a href="FAQ.html#whats-the-relationship-between-scio-and-google-cloud-dataflow-" class="header">What&rsquo;s the relationship between Scio and Google Cloud Dataflow?</a></li>
    <li><a href="FAQ.html#how-does-scio-compare-to-scalding-or-spark-" class="header">How does Scio compare to Scalding or Spark?</a></li>
    <li><a href="FAQ.html#what-are-gce-availability-zone-and-gcs-bucket-location-" class="header">What are GCE availability zone and GCS bucket location?</a></li>
  </ul></li>
  <li><a href="FAQ.html#programming-questions" class="header">Programming questions</a>
  <ul>
    <li><a href="FAQ.html#how-do-i-setup-a-new-sbt-project-" class="header">How do I setup a new SBT project?</a></li>
    <li><a href="FAQ.html#how-do-i-deploy-scio-jobs-to-dataflow-" class="header">How do I deploy Scio jobs to Dataflow?</a></li>
    <li><a href="FAQ.html#how-do-i-use-the-snapshot-builds-of-scio-" class="header">How do I use the SNAPSHOT builds of Scio?</a></li>
    <li><a href="FAQ.html#how-do-i-unit-test-pipelines-" class="header">How do I unit test pipelines?</a></li>
    <li><a href="FAQ.html#how-do-i-combine-multiple-input-sources-" class="header">How do I combine multiple input sources?</a></li>
    <li><a href="FAQ.html#how-do-i-log-in-a-job-" class="header">How do I log in a job?</a></li>
    <li><a href="FAQ.html#how-do-i-use-beams-java-api-in-scio-" class="header">How do I use Beam&rsquo;s Java API in Scio?</a></li>
    <li><a href="FAQ.html#what-are-the-different-types-of-joins-and-performance-implication-" class="header">What are the different types of joins and performance implication?</a></li>
    <li><a href="FAQ.html#how-to-create-dataflow-job-template-" class="header">How to create Dataflow job template?</a></li>
    <li><a href="FAQ.html#how-do-i-cancel-a-job-after-certain-time-period-" class="header">How do I cancel a job after certain time period?</a></li>
    <li><a href="FAQ.html#why-cant-i-have-an-scollection-inside-another-scollection-" class="header">Why can&rsquo;t I have an SCollection inside another SCollection?</a></li>
  </ul></li>
  <li><a href="FAQ.html#bigquery-questions" class="header">BigQuery questions</a>
  <ul>
    <li><a href="FAQ.html#what-is-bigquery-dataset-location-" class="header">What is BigQuery dataset location?</a></li>
    <li><a href="FAQ.html#how-stable-is-the-type-safe-bigquery-api-" class="header">How stable is the type safe BigQuery API?</a></li>
    <li><a href="FAQ.html#how-do-i-work-with-nested-options-in-type-safe-bigquery-" class="header">How do I work with nested Options in type safe BigQuery?</a></li>
    <li><a href="FAQ.html#how-do-i-unit-test-bigquery-queries-" class="header">How do I unit test BigQuery queries?</a></li>
    <li><a href="FAQ.html#how-do-i-stream-to-a-partitioned-bigquery-table-" class="header">How do I stream to a partitioned BigQuery table?</a></li>
    <li><a href="FAQ.html#how-do-i-invalidate-cached-bigquery-results-or-disable-cache-" class="header">How do I invalidate cached BigQuery results or disable cache?</a></li>
    <li><a href="FAQ.html#how-does-bigquery-determines-job-priority-" class="header">How does BigQuery determines job priority?</a></li>
  </ul></li>
  <li><a href="FAQ.html#streaming-questions" class="header">Streaming questions</a>
  <ul>
    <li><a href="FAQ.html#how-do-i-update-a-streaming-job-" class="header">How do I update a streaming job?</a></li>
  </ul></li>
  <li><a href="FAQ.html#other-io-components" class="header">Other IO components</a>
  <ul>
    <li><a href="FAQ.html#how-do-i-access-various-files-outside-of-a-sciocontext-" class="header">How do I access various files outside of a ScioContext?</a></li>
    <li><a href="FAQ.html#how-do-i-reduce-datastore-boilerplate-" class="header">How do I reduce Datastore boilerplate?</a></li>
    <li><a href="FAQ.html#how-do-i-throttle-bigtable-writes-" class="header">How do I throttle Bigtable writes?</a></li>
    <li><a href="FAQ.html#how-do-i-use-custom-kryo-serializers-" class="header">How do I use custom Kryo serializers?</a></li>
    <li><a href="FAQ.html#what-kryo-tuning-options-are-there-" class="header">What Kryo tuning options are there?</a></li>
  </ul></li>
  <li><a href="FAQ.html#development-environment-issues" class="header">Development environment issues</a>
  <ul>
    <li><a href="FAQ.html#how-do-i-keep-sbt-from-running-out-of-memory-" class="header">How do I keep SBT from running out of memory?</a></li>
    <li><a href="FAQ.html#how-do-i-fix-sbt-heap-size-error-in-intellij-" class="header">How do I fix SBT heap size error in IntelliJ?</a></li>
    <li><a href="FAQ.html#how-do-i-fix-error-in-intellij-" class="header">How do I fix &ldquo;Unable to create parent directories&rdquo; error in IntelliJ?</a></li>
    <li><a href="FAQ.html#how-to-make-intellij-idea-work-with-type-safe-bigquery-classes-" class="header">How to make IntelliJ IDEA work with type safe BigQuery classes?</a></li>
  </ul></li>
  <li><a href="FAQ.html#common-issues" class="header">Common issues</a>
  <ul>
    <li><a href="FAQ.html#what-does-mean-" class="header">What does &ldquo;Cannot prove that T1 &lt;:&lt; T2&rdquo; mean?</a></li>
    <li><a href="FAQ.html#how-do-i-fix-invalid-default-bigquery-credentials-" class="header">How do I fix invalid default BigQuery credentials?</a></li>
    <li><a href="FAQ.html#why-are-my-typed-bigquery-case-classes-not-up-to-date-" class="header">Why are my typed BigQuery case classes not up to date?</a></li>
    <li><a href="FAQ.html#how-do-i-fix-with-bigquery-" class="header">How do I fix &ldquo;SocketTimeoutException&rdquo; with BigQuery?</a></li>
    <li><a href="FAQ.html#why-do-i-see-names-like-in-the-ui-" class="header">Why do I see names like &ldquo;<a href="mailto:&#109;a&#x69;&#x6e;&#x40;&#123;&#78;a&#116;&#105;&#x76;e&#77;&#101;&#116;&#x68;&#111;d&#65;cce&#115;&#x73;&#x6f;&#x72;I&#x6d;pl&#46;&#46;&#46;&#125;">&#109;a&#x69;&#x6e;&#x40;&#123;&#78;a&#116;&#105;&#x76;e&#77;&#101;&#116;&#x68;&#111;d&#65;cce&#115;&#x73;&#x6f;&#x72;I&#x6d;pl&#46;&#46;&#46;&#125;</a>&rdquo; in the UI?</a></li>
    <li><a href="FAQ.html#how-do-i-fix-error-" class="header">How do I fix &ldquo;RESOURCE_EXHAUSTED&rdquo; error?</a></li>
    <li><a href="FAQ.html#can-i-use-trait-instead-of-method-" class="header">Can I use &ldquo;scala.App&rdquo; trait instead of &ldquo;main&rdquo; method?</a></li>
    <li><a href="FAQ.html#how-to-inspect-the-content-of-an-scollection-" class="header">How to inspect the content of an <code>SCollection</code>?</a></li>
    <li><a href="FAQ.html#how-do-i-improve-side-input-performance-" class="header">How do I improve side input performance?</a></li>
    <li><a href="FAQ.html#how-do-i-control-concurrency-number-of-dofn-threads-in-dataflow-workers" class="header">How do I control concurrency (number of DoFn threads) in Dataflow workers</a></li>
    <li><a href="FAQ.html#how-to-manually-investigate-a-cloud-dataflow-worker" class="header">How to manually investigate a Cloud Dataflow worker</a></li>
  </ul></li>
</ul>
</div>
<h3><a href="#general-questions" name="general-questions" class="anchor"><span class="anchor-link"></span></a>General questions</h3>
<h4><a href="#whats-the-status-of-scio-" name="whats-the-status-of-scio-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s the status of Scio?</h4>
<p>Scio is widely being used for production data pipelines at Spotify and is our preferred framework for building new pipelines on Google Cloud. We run Scio on <a href="https://cloud.google.com/dataflow/">Google Cloud Dataflow</a> service in both batch and streaming modes. However it&rsquo;s still under heavy development and there might be minor breaking API changes from time to time.</p>
<h4><a href="#whos-using-scio-" name="whos-using-scio-" class="anchor"><span class="anchor-link"></span></a>Who&rsquo;s using Scio?</h4>
<p>Spotify uses Scio for all new data pipelines running on Google Cloud Platform, including music recommendation, monetization, artist insights and business analysis. We also use BigQuery, Bigtable and Datastore heavily with Scio. We use Scio in both batch and streaming mode.</p>
<p>As of mid 2017, there&rsquo;re 200+ developers and 700+ production pipelines. The largest batch job we&rsquo;ve seen uses 800 n1-highmem-32 workers (25600 CPUs, 166.4TB RAM) and processes 325 billion rows from Bigtable (240TB). We also have numerous jobs that process 10TB+ of BigQuery data daily. On the streaming front, we have many jobs with 30+ n1-standard-16 workers (480 CPUs, 1.8TB RAM) and SSD disks for real time machine learning or reporting.</p>
<p>For a incomplete list of users, see the <a href="./Powered-By.html">Powered By</a> page.</p>
<h4><a href="#whats-the-relationship-between-scio-and-apache-beam-" name="whats-the-relationship-between-scio-and-apache-beam-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s the relationship between Scio and Apache Beam?</h4>
<p>Scio is a Scala API built on top of <a href="https://beam.apache.org/">Apache Beam</a>&rsquo;s Java SDK. Scio aims to offer a concise, idiomatic Scala API for a subset of Beam&rsquo;s features, plus extras we find useful, like REPL, type safe BigQuery, and IO taps.</p>
<h4><a href="#whats-the-relationship-between-scio-and-google-cloud-dataflow-" name="whats-the-relationship-between-scio-and-google-cloud-dataflow-" class="anchor"><span class="anchor-link"></span></a>What&rsquo;s the relationship between Scio and Google Cloud Dataflow?</h4>
<p>Scio (version before 0.3.0) was originally built on top of Google Cloud Dataflow&rsquo;s <a href="https://github.com/GoogleCloudPlatform/DataflowJavaSDK">Java SDK</a>. Google donated the code base to Apache and renamed it Beam. Cloud Dataflow became one of the supported runners, alongside Apache Flink &amp; Apache Spark. Scio 0.3.x is built on top of Beam 0.6.0 and 0.4.x is built on top of Beam 2.x. Many users run Scio on the Dataflow runner today.</p>
<h4><a href="#how-does-scio-compare-to-scalding-or-spark-" name="how-does-scio-compare-to-scalding-or-spark-" class="anchor"><span class="anchor-link"></span></a>How does Scio compare to Scalding or Spark?</h4>
<p>Check out the wiki page on <a href="./Scio%2C-Scalding-and-Spark.html">Scio, Scalding and Spark</a>. Also check out <a href="https://github.com/spotify/big-data-rosetta-code">Big Data Rosetta Code</a> for some snippets.</p>
<h4><a href="#what-are-gce-availability-zone-and-gcs-bucket-location-" name="what-are-gce-availability-zone-and-gcs-bucket-location-" class="anchor"><span class="anchor-link"></span></a>What are GCE availability zone and GCS bucket location?</h4>
<ul>
  <li>GCE <a href="https://cloud.google.com/compute/docs/zones">availability zone</a> is where the Google Cloud Dataflow service spins up VM instances for your job, e.g. <code>us-east1-a</code>.</li>
  <li>Each GCS bucket (<code>gs://bucket</code>) has a <a href="https://cloud.google.com/storage/docs/storage-classes">storage class</a> and <a href="https://cloud.google.com/storage/docs/bucket-locations">bucket location</a> that affects availability, latency and price. The location should be close to GCE availability zone. Dataflow uses <code>--stagingLocation</code> for job jars, temporary files and BigQuery I/O.</li>
</ul>
<h3><a href="#programming-questions" name="programming-questions" class="anchor"><span class="anchor-link"></span></a>Programming questions</h3>
<h4><a href="#how-do-i-setup-a-new-sbt-project-" name="how-do-i-setup-a-new-sbt-project-" class="anchor"><span class="anchor-link"></span></a>How do I setup a new SBT project?</h4>
<p>Read the <a href="Getting-Started.html#sbt-project-setup">documentation</a>.</p>
<h4><a href="#how-do-i-deploy-scio-jobs-to-dataflow-" name="how-do-i-deploy-scio-jobs-to-dataflow-" class="anchor"><span class="anchor-link"></span></a>How do I deploy Scio jobs to Dataflow?</h4>
<p>When developing locally, you can do <code>sbt &quot;runMain MyClass ...</code> or just <code>runMain MyClass ...</code> in the SBT console without building any artifacts.</p>
<p>When deploying to the cloud, we recommend using <a href="https://github.com/xerial/sbt-pack">sbt-pack</a> or <a href="https://github.com/sbt/sbt-native-packager">sbt-native-packager</a> plugin instead of <a href="https://github.com/sbt/sbt-assembly">sbt-assembly</a>. Unlike assembly, they pack dependency jars in a directory instead of merging them, so that we don&rsquo;t have to deal with merge strategy and dependency jars can be cached by Dataflow service.</p>
<p>At Spotify we pack jars with sbt-pack, build docker images with <a href="https://github.com/marcuslonnberg/sbt-docker">sbt-docker</a> together with orchestration components e.g. <a href="https://github.com/spotify/luigi">Luigi</a> or <a href="https://github.com/apache/incubator-airflow">Airflow</a> and deploy them with <a href="https://github.com/spotify/styx">Styx</a>.</p>
<h4><a href="#how-do-i-use-the-snapshot-builds-of-scio-" name="how-do-i-use-the-snapshot-builds-of-scio-" class="anchor"><span class="anchor-link"></span></a>How do I use the SNAPSHOT builds of Scio?</h4>
<p>Commits to Scio master are automatically published to Sonatype via continuous integration. To use the latest SNAPSHOT artifact, add the following line to your <code>build.sbt</code>.</p>
<pre class="prettyprint"><code class="language-sbt">resolvers += Resolver.sonatypeRepo(&quot;snapshots&quot;)
</code></pre>
<p>Or you can configure SBT globally by adding the following to <code>~/.sbt/1.0/global.sbt</code>.</p>
<pre class="prettyprint"><code class="language-sbt">resolvers ++= Seq(
  Resolver.sonatypeRepo(&quot;snapshots&quot;)
  // other resolvers
)
</code></pre>
<h4><a href="#how-do-i-unit-test-pipelines-" name="how-do-i-unit-test-pipelines-" class="anchor"><span class="anchor-link"></span></a>How do I unit test pipelines?</h4>
<p>Any Scala or Java unit testing frameworks can be used with Scio but we provide some utilities for <a href="http://www.scalatest.org/">ScalaTest</a>.</p>
<ul>
  <li><a href="https://spotify.github.io/scio/api/com/spotify/scio/testing/PipelineTestUtils.html" title="com.spotify.scio.testing.PipelineTestUtils"><code>PipelineTestUtils</code></a> - utilities for testing parts of a pipeline</li>
  <li><a href="https://spotify.github.io/scio/api/com/spotify/scio/testing/JobTest$.html" title="com.spotify.scio.testing.JobTest"><code>JobTest</code></a> - for testing pipelines end-to-end with complete arguments and IO coverage</li>
  <li><a href="https://spotify.github.io/scio/api/com/spotify/scio/testing/SCollectionMatchers.html" title="com.spotify.scio.testing.SCollectionMatchers"><code>SCollectionMatchers</code></a> - ScalaTest matchers for <code>SCollection</code></li>
  <li><a href="https://spotify.github.io/scio/api/com/spotify/scio/testing/PipelineSpec.html" title="com.spotify.scio.testing.PipelineSpec"><code>PipelineSpec</code></a> - shortcut for ScalaTest <code>FlatSpec</code> with utilities and matchers</li>
</ul>
<p>The best place to find example useage of <code>JobTest</code> and <code>SCollectionMatchers</code> are their respective tests in <a href="https://github.com/spotify/scio/tree/master/scio-test/src/test/scala/com/spotify/scio/testing/JobTestTest.scala">JobTestTest</a> and <a href="https://github.com/spotify/scio/tree/master/scio-test/src/test/scala/com/spotify/scio/testing/SCollectionMatchersTest.scala">SCollectionMatchersTest</a>. For more examples see:</p>
<ul>
  <li><a href="https://github.com/spotify/scio/tree/master/scio-examples/src/test/scala/com/spotify/scio/examples">scio-examples</a></li>
  <li><a href="https://github.com/spotify/big-data-rosetta-code/tree/master/src/test/scala/com/spotify/bdrc/testing">https://github.com/spotify/big-data-rosetta-code/tree/master/src/test/scala/com/spotify/bdrc/testing</a></li>
</ul>
<h4><a href="#how-do-i-combine-multiple-input-sources-" name="how-do-i-combine-multiple-input-sources-" class="anchor"><span class="anchor-link"></span></a>How do I combine multiple input sources?</h4>
<p>How do I combine multiple input sources, e.g. different BigQuery tables, files located in different GCS buckets? You can combine <code>SCollection</code>s from different sources into one using the companion method <code>SCollection.unionAll</code>, for example:</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._
import com.spotify.scio.avro._
import com.spotify.scio.values._
import com.spotify.scio.avro.TestRecord

object MyJob {
  def main(cmdlineArgs: Array[String]): Unit = {
    val (sc, args) = ContextAndArgs(cmdlineArgs)

    val collections =
      Seq(&quot;gs://bucket1/data/*.avro&quot;, &quot;gs://bucket2/data/*.avro&quot;)
        .map(sc.avroFile[TestRecord](_))

    val all = SCollection.unionAll(collections)
  }
}
</code></pre>
<h4><a href="#how-do-i-log-in-a-job-" name="how-do-i-log-in-a-job-" class="anchor"><span class="anchor-link"></span></a>How do I log in a job?</h4>
<p>You can log in a Scio job with most common logging libraries but <code>slf4j</code> is included as a dependency. Define the logger instance as a member of the job <code>object</code> and use it inside a lambda.</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._
import org.slf4j.LoggerFactory

object MyJob {
  private val logger = LoggerFactory.getLogger(this.getClass)
  def main(cmdlineArgs: Array[String]): Unit = {
    val (sc, args) = ContextAndArgs(cmdlineArgs)

    sc.parallelize(1 to 100)
      .map { i =&gt;
        logger.info(s&quot;Element $i&quot;)
        i * i
      }
    // ...
  }
}
</code></pre>
<h4><a href="#how-do-i-use-beams-java-api-in-scio-" name="how-do-i-use-beams-java-api-in-scio-" class="anchor"><span class="anchor-link"></span></a>How do I use Beam&rsquo;s Java API in Scio?</h4>
<p>Scio exposes a few things to allow easy integration with native Beam Java API, notably:</p>
<ul>
  <li><code>ScioContext#customInput</code> to apply a <code>PTransform[_ &gt;: PBegin, PCollection[T]]</code> (source) and get a <code>SCollection[T]</code>.</li>
  <li><code>SCollection#applyTransform</code> to apply a <code>PTransform[_ &gt;: PCollection[T], PCollection[U]]</code> and get a <code>SCollection[U]</code></li>
  <li><code>SCollection#saveAsCustomOutput</code> to apply a <code>PTransform[_ &gt;: PCollection[T], PDone]</code> (sink) and get a <code>ClosedTap[T]</code>.</li>
</ul>
<p>See <a href="https://spotify.github.io/scio/examples/BeamExample.scala.html">BeamExample.scala</a> for more details. Custom I/O can also be tested via the <a href="https://spotify.github.io/scio/api/com/spotify/scio/testing/JobTest$.html" title="com.spotify.scio.testing.JobTest"><code>`JobTest`</code></a> harness.</p>
<h4><a href="#what-are-the-different-types-of-joins-and-performance-implication-" name="what-are-the-different-types-of-joins-and-performance-implication-" class="anchor"><span class="anchor-link"></span></a>What are the different types of joins and performance implication?</h4>
<ul>
  <li>Inner (<code>a.join(b)</code>), left (<code>a.leftOuterJoin(b)</code>), outer (<code>a.fullOuterJoin(b)</code>) performs better with a large LHS. So <code>a</code> should be the larger data set with potentially more hot keys, i.e. key with many values. Every key-value pair from every input is shuffled.</li>
  <li><code>join</code>/<code>leftOuterJoin</code> may be replaced by <code>hashJoin</code>/<code>leftHashJoin</code> if the RHS is small enough to fit in memory (e.g. &lt; 1GB). The RHS is used as a multi-map side input for the LHS. No shuffle is performed.</li>
  <li>Consider <code>skewedJoin</code> if some keys on the LHS are extremely hot.</li>
  <li>Consider <code>sparseOuterJoin</code> if you want a full outer join where RHS is much smaller than LHS, but may not fit in memory.</li>
  <li>Consider <code>cogroup</code> if you need to access value groups of each key.</li>
  <li><a href="https://spotify.github.io/scio/api/com/spotify/scio/util/MultiJoin$.html"><code>MultiJoin</code></a> supports inner, left, outer join and cogroup of up to 22 inputs.</li>
  <li>For multi-joins larger inputs should be on the left, e.g. <code>size(a) &gt;= size(b) &gt;= size(c) &gt;= size(d)</code> in <code>MultiJoin(a, b, c, d)</code>.</li>
  <li>Check out these <a href="http://www.lyh.me/slides/joins.html">slides</a> for more information on joins.</li>
  <li>Also see this section on <a href="https://cloud.google.com/dataflow/service/dataflow-service-desc#cloud-dataflow-shuffle">Cloud Dataflow Shuffle</a> service.</li>
</ul>
<h4><a href="#how-to-create-dataflow-job-template-" name="how-to-create-dataflow-job-template-" class="anchor"><span class="anchor-link"></span></a>How to create Dataflow job template?</h4>
<p>For Apache Beam based Scio (version &gt;= <code>0.3.0</code>) use <code>DataflowRunner</code> and specify <code>templateLocation</code> option. For example in CLI <code>--templateLocation=gs://&lt;bucket&gt;/job1</code>. Read more about templates <a href="https://cloud.google.com/dataflow/docs/templates/overview">here</a>.</p>
<h4><a href="#how-do-i-cancel-a-job-after-certain-time-period-" name="how-do-i-cancel-a-job-after-certain-time-period-" class="anchor"><span class="anchor-link"></span></a>How do I cancel a job after certain time period?</h4>
<p>You can wait on the <code>ScioResult</code> and call the internal <code>PipelineResult#cancel()</code> method if a timeout exception happens.</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._
import scala.concurrent.duration._

object MyJob {
  def main(cmdlineArgs: Array[String]): Unit = {
    val (sc, args) = ContextAndArgs(cmdlineArgs)

    // ...
    val closedSc: ScioExecutionContext = sc.run()
    val result: ScioResult = closedSc.waitUntilFinish(1.minute, cancelJob = true)
  }
}

</code></pre>
<h4><a href="#why-cant-i-have-an-scollection-inside-another-scollection-" name="why-cant-i-have-an-scollection-inside-another-scollection-" class="anchor"><span class="anchor-link"></span></a>Why can&rsquo;t I have an SCollection inside another SCollection?</h4>
<p>You cannot have an SCollection inside another SCollection, i.e. anything with type <code>SCollection[SCollection[T]]</code>. To explain this we have to go back to the relationship between <code>ScioContext</code> and <code>SCollection</code>. Every <code>ScioContext</code> represents a unique pipeline and every <code>SCollection</code> represents a stage in the pipeline execution, i.e. the state of the pipeline after some transforms has be applied. We start a pipeline code with <code>val sc = ...</code>, create new <code>SCollection</code>s with methods on <code>sc</code>, e.g. <code>sc.textFile</code>, and transform them with methods like <code>.map</code>, <code>.filter</code>, <code>.join</code>. Therefore each <code>SCollection</code> can trace its root to one single <code>sc</code>. The pipeline is submitted for execution when we call <code>sc.run()</code>. Hence we cannot have an <code>SCollection</code> inside another <code>SCollection</code> just as we cannot have a pipeline inside another pipeline.</p>
<h3><a href="#bigquery-questions" name="bigquery-questions" class="anchor"><span class="anchor-link"></span></a>BigQuery questions</h3>
<h4><a href="#what-is-bigquery-dataset-location-" name="what-is-bigquery-dataset-location-" class="anchor"><span class="anchor-link"></span></a>What is BigQuery dataset location?</h4>
<ul>
  <li>Each BigQuery dataset has a location (e.g. <code>US</code>, <code>EU</code>) and every table inside are stored in the same location. Tables in a <code>JOIN</code> must be from the same region. Also one can only import/export tables to a GCS bucket in the same location. Starting from v0.2.1, Scio will detect the dataset location of a query and create a staging dataset for <code>ScioContext#bigQuerySelect</code> and <code>@BigQueryType.fromQuery</code>. This location should be the same as that of your <code>--stagingLocation</code> GCS bucket. The old <code>-Dbigquery.staging_dataset.location</code> flag is removed.</li>
</ul>
<p>Because of these limitations and performance reasons, make sure <code>--zone</code>, <code>--stagingLocation</code> and <del><code>-Dbigquery.staging_dataset.location</code></del> location of BigQuery datasets are consistent.</p>
<h4><a href="#how-stable-is-the-type-safe-bigquery-api-" name="how-stable-is-the-type-safe-bigquery-api-" class="anchor"><span class="anchor-link"></span></a>How stable is the type safe BigQuery API?</h4>
<p><a href="io/Type-Safe-BigQuery.html">Type Safe BigQuery</a> API is considered stable and widely used at Spotify. There are several caveats however:</p>
<ul>
  <li>Both <a href="https://cloud.google.com/bigquery/query-reference">legacy</a> and <a href="https://cloud.google.com/bigquery/sql-reference/">SQL</a> syntax are supported although the SQL syntax is <strong>highly recommended</strong></li>
  <li>The system will detect legacy or SQL syntax and choose the correct one</li>
  <li>To override auto-detection, start the query with either <code>#legacysql</code> or <code>#standardsql</code> comment line</li>
  <li>Legacy syntax is less predictable, especially for complex queries and may be disabled in the future</li>
  <li>Case classes generated by <code>@BigQueryType.fromTable</code> or <code>@BigQueryType.fromQuery</code> are not recognized in IntelliJ IDEA, but see <a href="FAQ.html#how-to-make-intellij-idea-work-with-type-safe-bigquery-classes-">this section</a> for a workaround</li>
</ul>
<h4><a href="#how-do-i-work-with-nested-options-in-type-safe-bigquery-" name="how-do-i-work-with-nested-options-in-type-safe-bigquery-" class="anchor"><span class="anchor-link"></span></a>How do I work with nested Options in type safe BigQuery?</h4>
<p>Any nullable field in BigQuery is translated to <code>Option[T]</code> by the type safe BigQuery API and it can be clunky to work with rows with multiple or nested fields. For example:</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio.bigquery.types.BigQueryType

@BigQueryType.fromSchema(&quot;&quot;&quot;{
    |&quot;fields&quot;: [{
    | &quot;type&quot;:&quot;RECORD&quot;,
    | &quot;mode&quot;: &quot;NULLABLE&quot;,
    | &quot;name&quot;:&quot;user&quot;,
    | &quot;fields&quot;:[
    |   {&quot;mode&quot;: &quot;NULLABLE&quot;, &quot;name&quot;:&quot;email&quot;, &quot;type&quot;: &quot;STRING&quot;},
    |   {&quot;mode&quot;: &quot;REQUIRED&quot;,&quot;name&quot;:&quot;name&quot;,&quot;type&quot;:&quot;STRING&quot;}]
    |}]}&quot;&quot;&quot;.stripMargin)
class Row

def doSomethingWithRow(row: Row) = {
  if (row.user.isDefined) {  // Option[User]
    val email = row.user.get.email  // Option[String]
    if (email.isDefined) {
      doSomething(email.get)
    }
  }
}
</code></pre>
<p>For comprehension is a nicer alternative in these cases:</p>
<pre class="prettyprint"><code class="language-scala">def doSomethingWithRowUsingFor(row: Row) = {
  val e: Option[String] =
    for {
      u &lt;- row.user
      e &lt;- u.email
    } yield e
  e.foreach(doSomething)
}
</code></pre>
<p>Also see these <a href="http://www.lyh.me/slides/for-yield.html">slides</a> and this <a href="https://dzone.com/articles/scala-comprehensions-options">blog article</a>.</p>
<h4><a href="#how-do-i-unit-test-bigquery-queries-" name="how-do-i-unit-test-bigquery-queries-" class="anchor"><span class="anchor-link"></span></a>How do I unit test BigQuery queries?</h4>
<p>BigQuery doesn&rsquo;t provide a way to unit test query logic locally, but we can query the service directly in an integration test. Take a look at <a href="https://github.com/spotify/scio/tree/master/scio-bigquery/src/it/scala/com/spotify/scio/bigquery/BigQueryIT.scala">BigQueryIT.scala</a>. <code>MockBigQuery</code> will create temporary tables on the service, feed them with mock data, and substitute table references in your query string with the mocked ones.</p>
<h4><a href="#how-do-i-stream-to-a-partitioned-bigquery-table-" name="how-do-i-stream-to-a-partitioned-bigquery-table-" class="anchor"><span class="anchor-link"></span></a>How do I stream to a partitioned BigQuery table?</h4>
<p>Currently there is no way to create a <a href="https://cloud.google.com/bigquery/docs/partitioned-tables">partitioned</a> BigQuery table via Scio/Beam when streaming, however it is possible to stream to a partitioned table if it is already created.</p>
<p>This can be done by using fixed windows and using the window bounds to infer date. As of Scio 0.4.0-beta2 this looks as follows:</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._
import org.apache.beam.sdk.values.ValueInSingleWindow
import org.apache.beam.sdk.transforms.SerializableFunction
import org.apache.beam.sdk.transforms.windowing.IntervalWindow
import com.google.api.services.bigquery.model.TableRow
import org.apache.beam.sdk.io.gcp.bigquery.{BigQueryIO, TableDestination}
import BigQueryIO.Write.{CreateDisposition, WriteDisposition}
import org.joda.time.format.DateTimeFormat
import org.joda.time.{DateTimeZone, Duration}

class DayPartitionFunction() extends SerializableFunction[ValueInSingleWindow[TableRow], TableDestination] {
  override def apply(input: ValueInSingleWindow[TableRow]): TableDestination = {
    val partition = DateTimeFormat.forPattern(&quot;yyyyMMdd&quot;).withZone(DateTimeZone.UTC)
      .print(input.getWindow.asInstanceOf[IntervalWindow].start())
    new TableDestination(&quot;project:dataset.partitioned$&quot; + partition, &quot;&quot;)
  }
}

object BQPartitionedJob {

  def myStringToTableRowConversion: String =&gt; TableRow = ???

  def main(cmdlineArgs: Array[String]): Unit = {
    val (sc, args) = ContextAndArgs(cmdlineArgs)

    sc.pubsubSubscription[String](&quot;projects/data-university/topics/data-university&quot;)
      .withFixedWindows(Duration.standardSeconds(30))
      // Convert to `TableRow`
      .map(myStringToTableRowConversion)
      .saveAsCustomOutput(
        &quot;SaveAsDayPartitionedBigQuery&quot;,
        BigQueryIO.writeTableRows().to(
          new DayPartitionFunction())
          .withWriteDisposition(WriteDisposition.WRITE_APPEND)
          .withCreateDisposition(CreateDisposition.CREATE_NEVER)
      )

    sc.run()
  }
}
</code></pre>
<p>In Scio 0.3.X it is possible to achieve the same behaviour using <code>SerializableFunction[BoundedWindow, String]</code> and <code>BigQueryIO.Write.to</code>. It is also possible to stream to separate tables with a Date suffix by modifying <code>DayPartitionFunction</code>, specifying the Schema, and changing the CreateDisposition to <code>CreateDisposition.CREATE_IF_NEEDED</code>.</p>
<h4><a href="#how-do-i-invalidate-cached-bigquery-results-or-disable-cache-" name="how-do-i-invalidate-cached-bigquery-results-or-disable-cache-" class="anchor"><span class="anchor-link"></span></a>How do I invalidate cached BigQuery results or disable cache?</h4>
<p>Scio&rsquo;s <a href="https://spotify.github.io/scio/api/com/spotify/scio/bigquery/client/BigQuery.html" title="com.spotify.scio.bigquery.client.BigQuery"><code>BigQuery client</code></a> in Scio caches query result in system property <code>bigquery.cache.directory</code>, which defaults to <code>$PWD/.bigquery</code>. Use <code>rm -rf .bigquery</code> to invalidate all cached results. To disable caching, set system property <code>bigquery.cache.enabled</code> to <code>false</code>.</p>
<h4><a href="#how-does-bigquery-determines-job-priority-" name="how-does-bigquery-determines-job-priority-" class="anchor"><span class="anchor-link"></span></a>How does BigQuery determines job priority?</h4>
<p>By default Scio runs BigQuery jobs with <code>BATCH</code> priority except when in the REPL where it runs with <code>INTERACTIVE</code>. To override this, set system property <code>bigquery.priority</code> to either <code>BATCH</code> or <code>INTERACTIVE</code>.</p>
<h3><a href="#streaming-questions" name="streaming-questions" class="anchor"><span class="anchor-link"></span></a>Streaming questions</h3>
<h4><a href="#how-do-i-update-a-streaming-job-" name="how-do-i-update-a-streaming-job-" class="anchor"><span class="anchor-link"></span></a>How do I update a streaming job?</h4>
<p>Dataflow allows streaming jobs to be updated on the fly by specifying <code>--update</code>, along with <code>--jobName=[your_job]</code> on the command line. See <a href="https://cloud.google.com/dataflow/pipelines/updating-a-pipeline">https://cloud.google.com/dataflow/pipelines/updating-a-pipeline</a> for detailed docs. Note that for this to work, Dataflow needs to be able to identify which transformations from the original job map to those in the replacement job. The easiest way to do so is to give unique names to transforms in the code itself. In Scio, this can be achieved by calling <code>.withName()</code> before applying the transform. For example:</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._

def main(cmdlineArgs: Array[String]): Unit = {
  val (sc, args) = ContextAndArgs(cmdlineArgs)
  sc.textFile(args(&quot;input&quot;))
    .withName(&quot;MakeUpper&quot;).map(_.toUpperCase)
    .withName(&quot;BigWords&quot;).filter(_.length &gt; 6)
}
</code></pre>
<p>In this example, the <code>map</code>&rsquo;s transform name is &ldquo;MakeUpper&rdquo; and the <code>filter</code>&rsquo;s is &ldquo;BigWords&rdquo;. If we later decided that we want to count 6 letter words as &ldquo;big&rdquo; too, then we can change it to <code>_.length &gt; 5</code>, and because the transform name is the same the job can be updated on the fly.</p>
<h3><a href="#other-io-components" name="other-io-components" class="anchor"><span class="anchor-link"></span></a>Other IO components</h3>
<h4><a href="#how-do-i-access-various-files-outside-of-a-sciocontext-" name="how-do-i-access-various-files-outside-of-a-sciocontext-" class="anchor"><span class="anchor-link"></span></a>How do I access various files outside of a ScioContext?</h4>
<ul>
  <li>For Scio version &gt;= <code>0.4.0</code></li>
</ul>
<p>Starting from Scio <code>0.4.0</code> you can use Apache Beam&rsquo;s <a href="https://beam.apache.org/releases/javadoc/2.18.0/?org/apache/beam/sdk/io/FileSystems.html" title="org.apache.beam.sdk.io.FileSystems"><code>Filesystems</code></a> abstraction:</p>
<pre class="prettyprint"><code class="language-scala">import org.apache.beam.sdk.io.FileSystems
// the path can be any of the supported Filesystems, e.g. local, GCS, HDFS
def readmeResource = FileSystems.matchNewResource(&quot;gs://&lt;bucket&gt;/README.md&quot;, false)
def readme = FileSystems.open(readmeResource)
</code></pre>
<ul>
  <li>For Scio version &lt; <code>0.4.0</code></li>
</ul><div class="callout note "><div class="callout-title">Note</div>
<p>This part is GCS specific.</p></div>
<p>You can get a <a href="https://beam.apache.org/releases/javadoc/2.18.0/?org/apache/beam/sdk/extensions/gcp/options/GcsOptions.html#getGcsUtil--" title="org.apache.beam.sdk.extensions.gcp.options.GcsOptions"><code>`GcsUtil`</code></a> instance from <code>ScioContext</code>, which can be used to open GCS files in read or write mode.</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio.ContextAndArgs
import org.apache.beam.sdk.extensions.gcp.options.GcsOptions

def main(cmdlineArgs: Array[String]): Unit = {
  val (sc, args) = ContextAndArgs(cmdlineArgs)
  val gcsUtil = sc.optionsAs[GcsOptions].getGcsUtil
  // ...
}
</code></pre>
<h4><a href="#how-do-i-reduce-datastore-boilerplate-" name="how-do-i-reduce-datastore-boilerplate-" class="anchor"><span class="anchor-link"></span></a>How do I reduce Datastore boilerplate?</h4>
<p>Datastore <code>Entity</code> class is actually generated from <a href="https://github.com/spotify/scio/tree/master/scio-examples/src/test/scala/com/spotify/scio/examples/extra/MagnolifyDatastoreExampleTest.scala">Protobuf</a> which uses the builder pattern and very boilerplate heavy. You can use the <a href="https://github.com/spotify/magnolify">Magnolify</a> library to seamlessly convert bewteen case classes and <code>Entity</code>s. See <a href="https://spotify.github.io/scio/examples/MagnolifyDatastoreExample.scala.html">MagnolifyDatastoreExample.scala</a> for an example job and <a href="https://github.com/spotify/scio/tree/master/scio-examples/src/test/scala/com/spotify/scio/examples/extra/MagnolifyDatastoreExampleTest.scala">MagnolifyDatastoreExampleTest.scala</a> for tests.</p>
<h4><a href="#how-do-i-throttle-bigtable-writes-" name="how-do-i-throttle-bigtable-writes-" class="anchor"><span class="anchor-link"></span></a>How do I throttle Bigtable writes?</h4>
<p>Currently Dataflow autoscaling may not work well with large writes BigtableIO. Specifically It does not take into account Bigtable IO rate limits and may scale up more workers and end up hitting the limit and eventually fail the job. As a workaround, you can enable throttling for Bigtable writes in Scio 0.4.0-alpha2 or later.</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio.values._
import com.spotify.scio.bigtable._
import com.google.cloud.bigtable.config.{BigtableOptions, BulkOptions}
import com.google.bigtable.v2.Mutation
import com.google.protobuf.ByteString

def main(cmdlineArgs: Array[String]): Unit = {
  // ...

  val data: SCollection[(ByteString, Iterable[Mutation])] = ???

  val btOptions =
    BigtableOptions.builder()
      .setProjectId(btProjectId)
      .setInstanceId(btInstanceId)
      .setBulkOptions(BulkOptions.builder()
        .enableBulkMutationThrottling()
        .setBulkMutationRpcTargetMs(10) // lower latency threshold, default is 100
        .build())
      .build()
  data.saveAsBigtable(btOptions, btTableId)

  // ...
}
</code></pre>
<h4><a href="#how-do-i-use-custom-kryo-serializers-" name="how-do-i-use-custom-kryo-serializers-" class="anchor"><span class="anchor-link"></span></a>How do I use custom Kryo serializers?</h4>
<p>See <a href="internals/Kryo.html">Kryo</a> for more.</p>
<p>Define a registrar class that extends <code>IKryoRegistrar</code> and annotate it with <code>@KryoRegistrar</code>. Note that the class name must ends with <code>KryoRegistrar</code>, i.e. <code>MyKryoRegistrar</code> for Scio to find it.</p>
<pre class="prettyprint"><code class="language-scala">import com.twitter.chill._
import com.esotericsoftware.kryo.Kryo
import com.spotify.scio.coders.KryoRegistrar
import com.twitter.chill.IKryoRegistrar

@KryoRegistrar
class MyKryoRegistrar extends IKryoRegistrar {
  override def apply(k: Kryo): Unit = {
    // register serializers for additional classes here
    k.forClass(new UserRecordSerializer)
    k.forClass(new AccountRecordSerializer)
    //...
  }
}
</code></pre>
<p>Registering just the classes can also improve Kryo performance. By registering, classes will be serialized as numeric IDs instead of fully qualified class names, hence saving space and network IO while shuffling. make</p>
<pre class="prettyprint"><code class="language-scala">import com.twitter.chill._
import com.esotericsoftware.kryo.Kryo
import com.spotify.scio.coders.KryoRegistrar
import com.twitter.chill.IKryoRegistrar

@KryoRegistrar
class MyKryoRegistrar extends IKryoRegistrar {
  override def apply(k: Kryo): Unit = {
    k.registerClasses(List(classOf[MyRecord1], classOf[MyRecord2]))
  }
}
</code></pre>
<h4><a href="#what-kryo-tuning-options-are-there-" name="what-kryo-tuning-options-are-there-" class="anchor"><span class="anchor-link"></span></a>What Kryo tuning options are there?</h4>
<p>See <a href="https://github.com/spotify/scio/tree/master/scio-core/src/main/java/com/spotify/scio/options/KryoOptions.java">KryoOptions.java</a> for a complete list of available Kryo tuning options. These can be passed via command line, for example:</p>
<p><code>--kryoBufferSize=1024 --kryoMaxBufferSize=8192 --kryoReferenceTracking=false --kryoRegistrationRequired=true</code></p>
<p>Among these, <code>--kryoRegistrationRequired=true</code> might be useful when developing to ensure that all data types in the pipeline are registered.</p>
<h3><a href="#development-environment-issues" name="development-environment-issues" class="anchor"><span class="anchor-link"></span></a>Development environment issues</h3>
<h4><a href="#how-do-i-keep-sbt-from-running-out-of-memory-" name="how-do-i-keep-sbt-from-running-out-of-memory-" class="anchor"><span class="anchor-link"></span></a>How do I keep SBT from running out of memory?</h4>
<p>SBT might run out of memory sometimes and show an <code>OutOfMemoryError: Metaspace</code> error. Override default memory setting with <code>-mem &lt;integer&gt;</code>, e.g. <code>sbt -mem 1024</code>.</p>
<h4><a href="#how-do-i-fix-sbt-heap-size-error-in-intellij-" name="how-do-i-fix-sbt-heap-size-error-in-intellij-" class="anchor"><span class="anchor-link"></span></a>How do I fix SBT heap size error in IntelliJ?</h4>
<p>If you encounter an SBT error with message &ldquo;Initial heap size set to a larger value than the maximum heap size&rdquo;, that is because IntelliJ has a lower default <code>-Xmx</code> for SBT than <code>-Xms</code> in our <code>.jvmopts</code>. To fix that, open <code>Preferences</code> -&gt; <code>Build, Execution, Deployment</code> -&gt; <code>Build Tools</code> -&gt; <code>sbt</code>, and update <code>Maximum heap size, MB</code> to <code>2048</code>.</p>
<h4><a href="#how-do-i-fix-error-in-intellij-" name="how-do-i-fix-error-in-intellij-" class="anchor"><span class="anchor-link"></span></a>How do I fix &ldquo;Unable to create parent directories&rdquo; error in IntelliJ?</h4>
<p>You might get an error message like <code>java.io.IOException: Unable to create parent directories of /Applications/IntelliJ IDEA CE.app/Contents/bin/.bigquery/012345abcdef.schema.json</code>. This usually happens to people who run IntelliJ IDEA with its bundled JVM. There are two solutions.</p>
<ul>
  <li>Install JDK from <a href="https://www.java.com/">java.com</a> and switch to it by following the &ldquo;All platforms: switch between installed runtimes&rdquo; section in this <a href="https://intellij-support.jetbrains.com/hc/en-us/articles/206544879-Selecting-the-JDK-version-the-IDE-will-run-under">page</a>.</li>
  <li>Override the bigquery <code>.cache</code> directory as a JVM compiler parameter. On the bottom right of the IntelliJ window, click the icon that looks like a clock, and then &ldquo;Configure&hellip;&rdquo;. Then, edit the JVM parameters to include the line <code>-Dbigquery.cache.directory=&lt;/path/to/repository&gt;/.bigquery</code>. Then, restart the compile server by clicking on the clock icon -&gt; Stop, and then Start.</li>
</ul>
<h4><a href="#how-to-make-intellij-idea-work-with-type-safe-bigquery-classes-" name="how-to-make-intellij-idea-work-with-type-safe-bigquery-classes-" class="anchor"><span class="anchor-link"></span></a>How to make IntelliJ IDEA work with type safe BigQuery classes?</h4>
<p>Due to issue <a href="https://youtrack.jetbrains.com/oauth?state=%2Fissue%2FSCL-8834">SCL-8834</a> case classes generated by <code>@BigQueryType.fromTable</code> or <code>@BigQueryType.fromQuery</code> are not recognized in IntelliJ IDEA. There are two workarounds. The first, IDEA plugin solution, is highly recommended.</p>
<ul>
  <li>IDEA Plugin</li>
</ul>
<p>Inside IntelliJ, <code>Preferences</code> -&gt; <code>Plugins</code> -&gt; <code>Browse repositories ...</code> and search <code>Scio</code>. Install the plugin, restart IntelliJ, recompile the project (use SBT or <a href="https://github.com/spotify/scio-idea-plugin#bigquery-location">IntelliJ</a>). You have to recompile the project each time you add/edit <code>@BigQueryType</code> macro. Plugin requires Scio &gt;= <code>0.2.2</code>. <a href="https://github.com/spotify/scio-idea-plugin#scio-idea-plugin">Documentation</a>.</p>
<ul>
  <li>Use case class from <code>@BigQueryType.toTable</code></li>
</ul>
<p>First start Scio REPL and generate case classes from your query or table.</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio.bigquery.types.BigQueryType

@BigQueryType.fromQuery(&quot;SELECT tornado, month FROM [publicdata:samples.gsod]&quot;)
class Tornado
</code></pre>
<p>Next print Scala code of the generated classes.</p>
<pre class="prettyprint"><code class="language-scala">Tornado.toPrettyString()
// res12: String = &quot;&quot;&quot;@BigQueryType.toTable
// case class Tornado(tornado: Option[Boolean], month: Long)&quot;&quot;&quot;
</code></pre>
<p>You can then paste the <code>@BigQueryType.fromQuery</code> code into your pipeline and use it with <code>sc.typedBigQuery</code>.</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._
import com.spotify.scio.values._
import com.spotify.scio.bigquery._

def main(cmdlineArgs: Array[String]): Unit = {
  val (sc, args) = ContextAndArgs(cmdlineArgs)

  val data: SCollection[Tornado] = sc.typedBigQuery[Tornado]
  // ...
}
</code></pre>
<h3><a href="#common-issues" name="common-issues" class="anchor"><span class="anchor-link"></span></a>Common issues</h3>
<h4><a href="#what-does-mean-" name="what-does-mean-" class="anchor"><span class="anchor-link"></span></a>What does &ldquo;Cannot prove that T1 &lt;:&lt; T2&rdquo; mean?</h4>
<p>Sometimes you get an error message like <code>Cannot prove that T1 &lt;:&lt; T2</code> when saving an <code>SCollection</code>. This is because some sink methods have an implicit argument like this which means element type <code>T</code> of <code>SCollection[T]</code> must be a sub-type of <code>TableRow</code> in order to save it to BigQuery. You have to map out elements to the required type before saving.</p>
<pre class="prettyprint"><code class="language-scala">def saveAsBigQuery(tableSpec: String)(implicit ev: T &lt;:&lt; TableRow)
</code></pre>
<p>In the case of <code>saveAsTypedBigQuery</code> you might get an <code>Cannot prove that T &lt;:&lt; com.spotify.scio.bigquery.types.BigQueryType.HasAnnotation.</code> error message. This API requires an <code>SCollection[T]</code> where <code>T</code> is a case class annotated with <code>@BigQueryType.toTable</code>. For example:</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._
import com.spotify.scio.values._
import com.spotify.scio.bigquery._
import com.spotify.scio.bigquery.types.BigQueryType

@BigQueryType.toTable
case class Result(user: String, score: Int)

def main(cmdlineArgs: Array[String]): Unit = {
  val (sc, args) = ContextAndArgs(cmdlineArgs)
  val p: SCollection[(String, Int)] = ???

  p.map(kv =&gt; Result(kv._1, kv._2))
   .saveAsTypedBigQuery(args(&quot;output&quot;))
}
</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>Scio uses <a href="https://docs.scala-lang.org/overviews/macros/annotations.html">Macro Annotations</a> and <a href="https://docs.scala-lang.org/overviews/macros/paradise.html">Macro Paradise</a> plugin to implement annotations. You need to add Macro Paradise plugin to your scala compiler as described <a href="https://docs.scala-lang.org/overviews/macros/paradise.html">here</a>.</p></div>
<h4><a href="#how-do-i-fix-invalid-default-bigquery-credentials-" name="how-do-i-fix-invalid-default-bigquery-credentials-" class="anchor"><span class="anchor-link"></span></a>How do I fix invalid default BigQuery credentials?</h4>
<p>If you don&rsquo;t specify a secret credential file for BigQuery <code>[1]</code>, Scio will use your default credentials (via <a href="https://github.com/google/google-auth-library-java/blob/master/oauth2_http/java/com/google/auth/oauth2/GoogleCredentials.java#L57">GoogleCredential.getApplicationDefault</a>), which:</p>
<blockquote>
  <p>Returns the Application Default Credentials which are used to identify and authorize the whole application. The following are searched (in order) to find the Application Default Credentials: - Credentials file pointed to by the <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable - Credentials provided by the Google Cloud SDK - <code>gcloud auth application-default login</code> command - Google App Engine built-in credentials - Google Cloud Shell built-in credentials - Google Compute Engine built-in credentials</p>
</blockquote>
<p>The easiest way to configure it on your local machine is to use the <code>gcloud auth application-default login</code> command.</p>
<p><code>[1]</code> Keep in mind that you can specify your credential file via <code>-Dbigquery.secret</code>.</p>
<h4><a href="#why-are-my-typed-bigquery-case-classes-not-up-to-date-" name="why-are-my-typed-bigquery-case-classes-not-up-to-date-" class="anchor"><span class="anchor-link"></span></a>Why are my typed BigQuery case classes not up to date?</h4>
<p>Case classes generated by <code>@BigQueryType.fromTable</code> or other macros might not update after table schema change. To solve this problem, remove the cached BigQuery metadata by deleting the <code>.bigquery</code> directory in your project root. If you would rather avoid any issues resulting from caching and schema evolution entirely, you can disable caching by setting the system property <code>bigquery.cache.enabled</code> to <code>false</code>.</p>
<h4><a href="#how-do-i-fix-with-bigquery-" name="how-do-i-fix-with-bigquery-" class="anchor"><span class="anchor-link"></span></a>How do I fix &ldquo;SocketTimeoutException&rdquo; with BigQuery?</h4>
<p>BigQuery requests may sometimes timeout, i.e. for complex queries over many tables.</p>
<pre><code>exception during macro expansion:
[error] java.net.SocketTimeoutException: Read timed out
</code></pre>
<p>It can be fixed by increasing the timeout settings (default 20s).</p>
<pre class="prettyprint"><code class="language-bash">sbt -Dbigquery.connect_timeout=30000 -Dbigquery.read_timeout=30000
</code></pre>
<h4><a href="#why-do-i-see-names-like-in-the-ui-" name="why-do-i-see-names-like-in-the-ui-" class="anchor"><span class="anchor-link"></span></a>Why do I see names like &ldquo;<a href="mailto:m&#97;&#105;&#110;&#x40;&#x7b;&#x4e;&#x61;&#116;&#105;v&#x65;&#77;e&#x74;&#x68;o&#100;&#65;&#99;c&#101;&#x73;s&#x6f;&#x72;Imp&#x6c;&#x2e;&#46;.&#125;">m&#97;&#105;&#110;&#x40;&#x7b;&#x4e;&#x61;&#116;&#105;v&#x65;&#77;e&#x74;&#x68;o&#100;&#65;&#99;c&#101;&#x73;s&#x6f;&#x72;Imp&#x6c;&#x2e;&#46;.&#125;</a>&rdquo; in the UI?</h4>
<p>Scio traverses JVM stack trace to figure out the proper name of each transform, i.e. <code>flatMap@{UserAnalysis.scala:30}</code> but may get confused if your jobs are under the <code>com.spotify.scio</code> package. Move them to a different package, e.g. <code>com.spotify.analytics</code> to fix the issue.</p>
<h4><a href="#how-do-i-fix-error-" name="how-do-i-fix-error-" class="anchor"><span class="anchor-link"></span></a>How do I fix &ldquo;RESOURCE_EXHAUSTED&rdquo; error?</h4>
<p>You might see errors like <code>RESOURCE_EXHAUSTED: IO error: No space left on disk</code> in a job. They usually indicate that you have allocated insufficient local disk space to process your job. If you are running your job with default settings, your job is running on 3 workers, each with 250 GB of local disk space. Consider modifying the default settings to increase the number of workers available to your job (via <code>--numWorkers</code>), to increase the default disk size per worker (via <code>--diskSizeGb</code>).</p>
<h4><a href="#can-i-use-trait-instead-of-method-" name="can-i-use-trait-instead-of-method-" class="anchor"><span class="anchor-link"></span></a>Can I use &ldquo;scala.App&rdquo; trait instead of &ldquo;main&rdquo; method?</h4>
<p>Your Scio applications should define a <code>main</code> method instead of extending <code>scala.App</code>. Applications extending <code>scala.App</code> due to delayed initialization and closure cleaning may not work properly.</p>
<h4><a href="#how-to-inspect-the-content-of-an-scollection-" name="how-to-inspect-the-content-of-an-scollection-" class="anchor"><span class="anchor-link"></span></a>How to inspect the content of an <code>SCollection</code>?</h4>
<p>There is multiple options here: - Use <code>debug()</code> method on an <code>SCollection</code> to print its content as the data flows through the DAG during the execution (after the <code>run</code> or <code>runAndCollect</code>) - Use a debugger and setup break points - make sure to break inside of your functions to stop control at the execution not the pipeline construction time - In <a href="./Scio-REPL.html">Scio-REPL</a>, use <code>runAndCollect()</code> to execute the pipeline and materialize the contents of an <code>SCollection</code></p>
<h4><a href="#how-do-i-improve-side-input-performance-" name="how-do-i-improve-side-input-performance-" class="anchor"><span class="anchor-link"></span></a>How do I improve side input performance?</h4>
<p>By default Dataflow workers allocate 100MB (see <a href="https://beam.apache.org/releases/javadoc/2.18.0/?org/apache/beam/runners/dataflow/options/DataflowWorkerHarnessOptions.html#getWorkerCacheMb--" title="org.apache.beam.runners.dataflow.options.DataflowWorkerHarnessOptions"><code>DataflowWorkerHarnessOptions#getWorkerCacheMb</code></a>) of memory for caching side inputs, and falls back to disk or network. Therefore jobs with large side inputs may be slow. To override this default, register <code>DataflowWorkerHarnessOptions</code> before parsing command line arguments and then pass <code>--workerCacheMb=N</code> when submitting the job.</p>
<pre class="prettyprint"><code class="language-scala">import com.spotify.scio._
import org.apache.beam.sdk.options.PipelineOptionsFactory
import org.apache.beam.runners.dataflow.options.DataflowWorkerHarnessOptions

def main(cmdlineArgs: Array[String]): Unit = {
  PipelineOptionsFactory.register(classOf[DataflowWorkerHarnessOptions])
  val (sc, args) = ContextAndArgs(cmdlineArgs)
  // ...
}
</code></pre>
<h4><a href="#how-do-i-control-concurrency-number-of-dofn-threads-in-dataflow-workers" name="how-do-i-control-concurrency-number-of-dofn-threads-in-dataflow-workers" class="anchor"><span class="anchor-link"></span></a>How do I control concurrency (number of DoFn threads) in Dataflow workers</h4>
<p>By default Google Cloud Dataflow will use as many threads (concurrent DoFns) per worker as appropriate (precise definition is an implementation detail), in same cases you might want to control this. Use <code>NumberOfWorkerHarnessThreads</code> option from <code>DataflowPipelineDebugOptions</code>. For example to use a single thread per worker on 8 vCPU machine, simply specify 8 vCPU worker machine type, and <code>--numberOfWorkerHarnessThreads=1</code> in CLI or set corresponding option in <code>DataflowPipelineDebugOptions</code>.</p>
<h4><a href="#how-to-manually-investigate-a-cloud-dataflow-worker" name="how-to-manually-investigate-a-cloud-dataflow-worker" class="anchor"><span class="anchor-link"></span></a>How to manually investigate a Cloud Dataflow worker</h4>
<p>First find the VM of the worker, the easiest place is through the GCE instance groups:</p>
<pre><code>gcloud compute ssh --project=&lt;project&gt; --zone=&lt;zone&gt; &lt;VM&gt;
</code></pre>
<p>To find the id of batch (for <code>batch</code> job) container:</p>
<pre><code>docker ps | grep &quot;batch\|streaming&quot; | awk &#39;{print $1}&#39;
</code></pre>
<p>To get into the harness container:</p>
<pre><code>docker exec -it &lt;container-id&gt; /bin/bash
</code></pre>
<p>To install java jdk tools:</p>
<pre><code>apt-get update
apt-get install default-jdk -y
</code></pre>
<p>To find java process:</p>
<pre><code>jps
</code></pre>
<p>To get GC stats:</p>
<pre><code>jstat -gcutil &lt;pid&gt; 1000 1000
</code></pre>
<p>To get stacktrace:</p>
<pre><code>jstack &lt;pid&gt;
</code></pre>
</div>
<div>
<a href="https://github.com/spotify/scio/tree/master/site/target/mdoc/FAQ.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.8.2*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="Changelog.html" title="Changelog" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Changelog
</span>
</div>
</a>
<a href="Powered-By.html" title="Powered By" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Powered By
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright (C) 2020 Spotify AB
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/spotify" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/spotifyeng" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="assets/javascripts/application.583bbe55.js"></script>
<script src="assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"."}})</script>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
